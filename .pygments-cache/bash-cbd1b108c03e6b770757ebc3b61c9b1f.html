<div class="highlight"><pre><span class="c">#! /bin/bash</span>
<span class="c"># Script to automate creating new OpenVPN clients</span>
<span class="c"># The client cert and key, along with the CA cert is</span>
<span class="c"># zipped up and placed somewhere to download securely</span>
<span class="c">#</span>
<span class="c"># H Cooper - 05/02/11</span>
<span class="c"># </span>
<span class="c"># edited by: N Lutz - 17.10.2014 info@nilslutz.de</span>
<span class="c">#</span>
<span class="c"># Usage: build-client-config &lt;common-name&gt;</span>

<span class="c"># Set where we&#39;re working from</span>
<span class="nv">OPENVPN_DIR</span><span class="o">=</span>/etc/openvpn
<span class="nv">OPENVPN_RSA_DIR</span><span class="o">=</span>/etc/openvpn/easy-rsa
<span class="nv">OPENVPN_KEYS</span><span class="o">=</span><span class="nv">$OPENVPN_RSA_DIR</span>/keys
<span class="nv">KEY_DOWNLOAD_PATH</span><span class="o">=</span>&lt;OVPN SPEICHERORT&gt;

<span class="c"># Either read the CN from $1 or prompt for it</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$1&quot;</span> <span class="o">]</span>
	<span class="k">then</span> <span class="nb">echo</span> -n <span class="s2">&quot;Enter new client common name (CN): &quot;</span>
	<span class="nb">read</span> -e CN
<span class="k">else</span>
	<span class="nv">CN</span><span class="o">=</span><span class="nv">$1</span>
<span class="k">fi</span>

<span class="c"># Ensure CN isn&#39;t blank</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$CN&quot;</span> <span class="o">]</span>
	<span class="k">then</span> <span class="nb">echo</span> <span class="s2">&quot;You must provide a CN.&quot;</span>
	<span class="nb">exit</span>
<span class="k">fi</span>

<span class="c"># Check the CN doesn&#39;t already exist</span>
<span class="k">if</span> <span class="o">[</span> -f <span class="nv">$OPENVPN_KEYS</span>/<span class="nv">$CN</span>.crt <span class="o">]</span>
	<span class="k">then</span> <span class="nb">echo</span> <span class="s2">&quot;Error: certificate with the CN $CN alread exists!&quot;</span>
		<span class="nb">echo</span> <span class="s2">&quot;    $OPENVPN_KEYS/$CN.crt&quot;</span>
	<span class="nb">exit</span>
<span class="k">fi</span>

<span class="c"># Enter the easy-rsa directory and establish the default variables</span>
<span class="nb">cd</span> <span class="nv">$OPENVPN_RSA_DIR</span>
<span class="nb">source</span> ./vars &gt; /dev/null
<span class="nb">export </span><span class="nv">KEY_CN</span><span class="o">=</span><span class="s2">&quot;$CN&quot;</span>

<span class="c"># Copied from build-key script (to ensure it works!)</span>
<span class="nb">export </span><span class="nv">EASY_RSA</span><span class="o">=</span><span class="s2">&quot;${EASY_RSA:-.}&quot;</span>
<span class="s2">&quot;$EASY_RSA/pkitool&quot;</span> --batch <span class="nv">$CN</span>

<span class="c"># cat keys and certs inline the .opvn file for easier exchange</span>
<span class="nv">DEFAULT</span><span class="o">=</span><span class="s2">&quot;default.ovpn&quot;</span>
<span class="nv">FILEEXT</span><span class="o">=</span><span class="s2">&quot;.ovpn&quot;</span>
<span class="nv">CRT</span><span class="o">=</span><span class="s2">&quot;.crt&quot;</span>
<span class="nv">CSR</span><span class="o">=</span><span class="s2">&quot;.csr&quot;</span>
<span class="nv">KEY</span><span class="o">=</span><span class="s2">&quot;.key&quot;</span>
<span class="nv">CA</span><span class="o">=</span><span class="s2">&quot;ca.crt&quot;</span>
<span class="nv">TA</span><span class="o">=</span><span class="s2">&quot;ta.key&quot;</span>

<span class="c">#1st Verify that client&#39;s Public Key Exists</span>
<span class="nb">cd</span> <span class="nv">$OPENVPN_KEYS</span>
<span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$CN$CRT</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">&quot;[ERROR]: Client Public Key Certificate not found: $CN$CRT&quot;</span>
 <span class="nb">exit</span>
<span class="k">fi</span>
<span class="nb">echo</span> <span class="s2">&quot;Client&#39;s cert found: $CN$CR&quot;</span>

<span class="c">#Then, verify that there is a private key for that client</span>
<span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$CN$KEY</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">&quot;[ERROR]: Client Private Key not found: $CN$KEY&quot;</span>
 <span class="nb">exit</span>
<span class="k">fi</span>
<span class="nb">echo</span> <span class="s2">&quot;Client&#39;s Private Key found: $CN$KEY&quot;</span>

<span class="c">#Confirm the CA public key exists</span>
<span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$CA</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">&quot;[ERROR]: CA Public Key not found: $CA&quot;</span>
 <span class="nb">exit</span>
<span class="k">fi</span>
<span class="nb">echo</span> <span class="s2">&quot;CA public Key found: $CA&quot;</span>

<span class="c">#Confirm the tls-auth ta key file exists</span>
<span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$TA</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">&quot;[ERROR]: tls-auth Key not found: $TA&quot;</span>
 <span class="nb">exit</span>
<span class="k">fi</span>
<span class="nb">echo</span> <span class="s2">&quot;tls-auth Private Key found: $TA&quot;</span>

<span class="c">#Ready to make a new .opvn file - Start by populating with the default file</span>
<span class="nb">cd</span> <span class="nv">$KEY_DOWNLOAD_PATH</span>
cat <span class="nv">$OPENVPN_RSA_DIR</span>/<span class="nv">$DEFAULT</span> &gt; <span class="nv">$CN$FILEEXT</span>

<span class="c">#Now, append the CA Public Cert</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;ca&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
cat <span class="nv">$OPENVPN_DIR</span>/<span class="nv">$CA</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;/ca&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>

<span class="c">#Next append the client Public Cert</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;cert&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
cat <span class="nv">$OPENVPN_KEYS</span>/<span class="nv">$CN$CRT</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;/cert&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>

<span class="c">#Then, append the client Private Key</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;key&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
cat <span class="nv">$OPENVPN_KEYS</span>/<span class="nv">$CN$KEY</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;/key&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>

<span class="c">#Finally, append the TA Private Key</span>
<span class="nb">echo</span> <span class="s2">&quot;key direction 1&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;tls-auth&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
cat <span class="nv">$OPENVPN_DIR</span>/<span class="nv">$TA</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;/tls-auth&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>

<span class="c"># Take the new cert and place it somewhere it can be downloaded securely</span>
chmod <span class="m">666</span> <span class="nv">$CN$FILEEXT</span>
rm <span class="nv">$OPENVPN_KEYS</span>/<span class="nv">$CN$CRT</span>
rm <span class="nv">$OPENVPN_KEYS</span>/<span class="nv">$CN$KEY</span>
rm <span class="nv">$OPENVPN_KEYS</span>/<span class="nv">$CN$CSR</span>
</pre></div>