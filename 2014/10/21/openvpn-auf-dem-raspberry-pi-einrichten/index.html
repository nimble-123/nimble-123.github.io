
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>OpenVPN auf dem RaspberryPi einrichten - Just My Two Cents</title>
  <meta name="author" content="Nils Lutz">

  
  <meta name="description" content="Da man in letzter Zeit ja immer öfters hört, wie wir alle massenweise ausspioniert werden. War es an der Zeit mein Netzwerk Zuhause ein wenig mehr &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://nlsltz.github.io/2014/10/21/openvpn-auf-dem-raspberry-pi-einrichten/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Just My Two Cents" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=Arvo:400,400italic,700,700italic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Playball" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-52478234-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="/">Just My Two Cents</a></h1>
  
    <h2>Linux, Raspberry Pi, Android</h2>
  
</hgroup>

</header>
  <div id="navigation">
    <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:nlsltz.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  </div>
  <div id="body"  >
    <div id="main">
      <div id="content">
        <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">OpenVPN Auf Dem RaspberryPi Einrichten</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-21T17:00:00+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><img class="right" src="/images/openvpn.png" width="200" height="200" title="OpenVPN Logo" alt="OpenVPN Logo">Da man in letzter Zeit ja immer öfters hört, wie wir alle massenweise ausspioniert werden. War es an der Zeit mein Netzwerk Zuhause ein wenig mehr abzusichern. Ich habe auch gerne Zugriff auf meine Geräte von außerhalb. Um einerseits den Status meines Pi zu überprüfen oder aber um meinem Medien Server bei Bedarf zu starten. Bisher hatte ich immer fahrlässig meinen Port <code>22</code> vom Pi ins Internet geöffnet.<!-- more --></p>

<p>Da das aber jedem mit auch nur ein bisschen Skill die Türen zu meinem Netzwerk öffnete, sollte dieser Umstand so schnell es geht behoben werden. So kam <a href="https://openvpn.net/">OpenVPN</a> auf den Plan. OpenVPN ist eine Open Source Applikation, die mit SSL/TLS verschlüsselt und auch Clients für sämtliche Plattformen(Android, iOS, Windows, OS X, Linux) anbietet. Nachfolgend erkläre ich die Installation des Servers auf dem Raspberry Pi, sowie die Client Konfiguration.</p>

<h2>Schritt 1</h2>

<p>OpenVPN und OpenSSL Pakete auf dem Pi installieren.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install openvpn opensll
</span></code></pre></td></tr></table></div></figure>


<h2>Schritt 2</h2>

<p>Damit die Schlüssel für die Authentifizierung generiert werden können nutzen wir die mitgelieferte Easy-RSA Skripte. Bevor wir sie allerdings nutzen kopieren wir sie in das Konfigurationsverzeichnis von OpenVPN.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo cp -r /usr/share/doc/openvpn/examples/easy-rsa/2.0 /etc/openvpn/easy-rsa
</span></code></pre></td></tr></table></div></figure>


<h2>Schritt 3</h2>

<p>Als nächsten werden die Grundeinstellungen an unsere Bedürfnisse angepasst. Dies geschieht in der Datei <code>/etc/openvpn/easy-rsa/vars</code>. In Zeile 15 muss das Verzeichnis von Easy-RSA angegeben werden. Zusätzlich ändern wir noch in Zeile 53 die Schlüssellänge auf 2048bit.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">EASY_RSA</span><span class="o">=</span><span class="s2">&quot;/etc/openvpn/easy-rsa&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">KEY_SIZE</span><span class="o">=</span>2048
</span></code></pre></td></tr></table></div></figure>


<h2>Schritt 4</h2>

<p>Wir wechseln ins Easy-RSA Verzeichnis und versorgen uns mit Root Rechten.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /etc/openvpn/easy-rsa
</span><span class='line'>sudo su
</span><span class='line'><span class="nb">source </span>vars
</span></code></pre></td></tr></table></div></figure>


<p>Weiter benötigen die Easy-RSA Skripte eine OpenSSL Konfiguration, welche wir uns einfach mit einem symbolischen Link erstellen</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ln -s openssl-1.0.0.cnf openssl.cnf
</span></code></pre></td></tr></table></div></figure>


<h2>Schritt 5</h2>

<p>So da nun alles eingestellt ist können wir damit beginnen die Zertifikate und Schlüssel zu erzeugen.</p>

<p>Der zweite Befehl fragt eine Reihe von Informationen ab. Lediglich das Land ist wichtig für unsere Konfiguration, der Rest kann außer Acht gelassen werden.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./clean-all
</span><span class='line'>./build-ca &lt;NAME DES VPNs&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Der nächste Befehl erzeugt aus dem zuvor erstellten Root Zertifikat einen Schlüssel für den Server. Auch hier werden wieder einige Informationen abgefragt. Das <code>Challenge Password</code> kann leer gelassen werden.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./build-key-server server
</span></code></pre></td></tr></table></div></figure>


<p>Zu letzt werden noch die Diffie-Hellman-Parameter generiert. Dadurch wird ein sicherer Schlüsselaustausch ermöglicht.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./build-dh
</span><span class='line'><span class="nb">exit</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Schritt 6</h2>

<p>Zertifikate und Schlüssel sind generiert. Also können wir uns jetzt um die OpenVPN Server Konfiguration kümmern.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo nano /etc/openvpn/openvpn.conf
</span></code></pre></td></tr></table></div></figure>


<p>In diese Datei gehört folgender Inhalt. Es werden die Orte der Zertifikate und Schlüssel angegeben. Die verwendeten Verschlüsselungsmodi lassen sich auch hier einstellen.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mode server
</span><span class='line'>tls-server
</span><span class='line'>
</span><span class='line'><span class="c"># virtual interface for vpn</span>
</span><span class='line'>dev tun
</span><span class='line'>
</span><span class='line'><span class="c"># protocol for port</span>
</span><span class='line'>proto udp
</span><span class='line'>
</span><span class='line'><span class="c"># port for vpn</span>
</span><span class='line'>port 1194
</span><span class='line'>
</span><span class='line'><span class="c"># keys and certificates</span>
</span><span class='line'>ca /etc/openvpn/easy-rsa/keys/ca.crt
</span><span class='line'>cert /etc/openvpn/easy-rsa/keys/server.crt
</span><span class='line'>key /etc/openvpn/easy-rsa/keys/server.key
</span><span class='line'>dh /etc/openvpn/easy-rsa/keys/dh2048.pem
</span><span class='line'>
</span><span class='line'><span class="c"># tls-auth server</span>
</span><span class='line'>key-direction 0
</span><span class='line'>tls-auth /etc/openvpn/easy-rsa/keys/ta.key
</span><span class='line'>
</span><span class='line'><span class="c"># cipher suites</span>
</span><span class='line'>cipher AES-256-CBC
</span><span class='line'>auth SHA512
</span><span class='line'>tls-cipher DHE-RSA-AES256-SHA
</span><span class='line'>
</span><span class='line'><span class="c"># user and group</span>
</span><span class='line'>user nobody
</span><span class='line'>group nogroup
</span><span class='line'>
</span><span class='line'><span class="c"># used subnet for vpn</span>
</span><span class='line'>server 10.0.1.0 255.255.255.0
</span><span class='line'>
</span><span class='line'><span class="c"># persistance</span>
</span><span class='line'>persist-key
</span><span class='line'>persist-tun
</span><span class='line'>
</span><span class='line'><span class="c"># logging</span>
</span><span class='line'>status /var/log/openvpn-status.log
</span><span class='line'>verb 3
</span><span class='line'>log-append /var/log/openvpn
</span><span class='line'>
</span><span class='line'><span class="c"># routing</span>
</span><span class='line'>client-to-client
</span><span class='line'>push <span class="s2">&quot;redirect-gateway def1 bypass-dhcp&quot;</span>
</span><span class='line'>push <span class="s2">&quot;dhcp-option DNS 85.214.20.141&quot;</span>
</span><span class='line'>push <span class="s2">&quot;dhcp-option DNS 8.8.8.8&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># compression</span>
</span><span class='line'>comp-lzo
</span><span class='line'>
</span><span class='line'><span class="c"># keep vpn session alive</span>
</span><span class='line'>keepalive <span class="m">10</span> 120
</span><span class='line'>
</span><span class='line'><span class="c"># user auth with username/password</span>
</span><span class='line'><span class="p">;</span>plugin /usr/lib/openvpn/openvpn-auth-pam.so login
</span><span class='line'><span class="p">;</span>client-cert-not-required<span class="p">;</span>
</span><span class='line'><span class="p">;</span>username-as-common-name
</span><span class='line'>
</span><span class='line'><span class="c"># certificate revocation list</span>
</span><span class='line'><span class="p">;</span>crl-verify /etc/openvpn/crl.pem
</span></code></pre></td></tr></table></div></figure>


<h2>Schritt 7</h2>

<p>Damit man vom Client auch eine Verbindung ins Internet über den OpenVPN Server bekommt muss eine Weiterleitung in der Firewall eingestellt werden. Diese Einstellung soll einen Neustart des Servers überstehen weshalb wir uns das folgende Skript anlegen.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo nano /etc/init.d/rpivpn
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#! /bin/sh</span>
</span><span class='line'><span class="c">### BEGIN INIT INFO</span>
</span><span class='line'><span class="c"># Provides:          rpivpn</span>
</span><span class='line'><span class="c"># Required-Start:    $remote_fs $syslog</span>
</span><span class='line'><span class="c"># Required-Stop:     $remote_fs $syslog</span>
</span><span class='line'><span class="c"># Default-Start:     2 3 4 5</span>
</span><span class='line'><span class="c"># Default-Stop:      0 1 6</span>
</span><span class='line'><span class="c"># Short-Description: VPN initialisation script</span>
</span><span class='line'><span class="c">### END INIT INFO</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;echo &quot;1&quot;  &gt; /proc/sys/net/ipv4/ip_forward&#39;</span> <span class="p">|</span> sudo -s
</span><span class='line'>sudo iptables -A INPUT -i tun+ -j ACCEPT
</span><span class='line'>sudo iptables -A FORWARD -i tun+ -j ACCEPT
</span><span class='line'>sudo iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
</span><span class='line'>sudo iptables -t nat -F POSTROUTING
</span><span class='line'>sudo iptables -t nat -A POSTROUTING -s 10.0.1.0/24 -o eth0 -j MASQUERADE
</span></code></pre></td></tr></table></div></figure>


<p>Nur noch die Rechte anpassen und dann einmal per Hand ausführen. Zusätzlich kommt das Skript noch in den Autostart.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo chmod +x /etc/init.d/rpivpn
</span><span class='line'>sudo update-rc.de rpivpn defaults
</span><span class='line'>sudo /etc/init.d/rpivpn
</span><span class='line'>sudo /etc/init.d/openvpn restart
</span></code></pre></td></tr></table></div></figure>


<h2>Schritt 8</h2>

<p>Damit wäre die Arbeit für den OpenVPN Server erledigt. Widmen wir uns nun der Client Konfiguration. Erstmal benötigen wir wieder Root Rechte und dann erzeugen wir uns ein Skript um automatisiert Client Konfigurationen erstellen zu können. Lediglich der Speicherort der fertigen Konfiguration muss angepasst werden im Skript.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo su
</span><span class='line'><span class="nb">cd</span> /etc/openvpn/easy-rsa/
</span><span class='line'>nano build-client-config
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#! /bin/bash</span>
</span><span class='line'><span class="c"># Script to automate creating new OpenVPN clients</span>
</span><span class='line'><span class="c"># The client cert and key, along with the CA cert is</span>
</span><span class='line'><span class="c"># zipped up and placed somewhere to download securely</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># H Cooper - 05/02/11</span>
</span><span class='line'><span class="c"># </span>
</span><span class='line'><span class="c"># edited by: N Lutz - 17.10.2014 info@nilslutz.de</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Usage: build-client-config &lt;common-name&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Set where we&#39;re working from</span>
</span><span class='line'><span class="nv">OPENVPN_DIR</span><span class="o">=</span>/etc/openvpn
</span><span class='line'><span class="nv">OPENVPN_RSA_DIR</span><span class="o">=</span>/etc/openvpn/easy-rsa
</span><span class='line'><span class="nv">OPENVPN_KEYS</span><span class="o">=</span><span class="nv">$OPENVPN_RSA_DIR</span>/keys
</span><span class='line'><span class="nv">KEY_DOWNLOAD_PATH</span><span class="o">=</span>&lt;OVPN SPEICHERORT&gt;
</span><span class='line'>
</span><span class='line'><span class="c"># Either read the CN from $1 or prompt for it</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$1&quot;</span> <span class="o">]</span>
</span><span class='line'>  <span class="k">then</span> <span class="nb">echo</span> -n <span class="s2">&quot;Enter new client common name (CN): &quot;</span>
</span><span class='line'>  <span class="nb">read</span> -e CN
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="nv">CN</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Ensure CN isn&#39;t blank</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$CN&quot;</span> <span class="o">]</span>
</span><span class='line'>  <span class="k">then</span> <span class="nb">echo</span> <span class="s2">&quot;You must provide a CN.&quot;</span>
</span><span class='line'>  <span class="nb">exit</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Check the CN doesn&#39;t already exist</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -f <span class="nv">$OPENVPN_KEYS</span>/<span class="nv">$CN</span>.crt <span class="o">]</span>
</span><span class='line'>  <span class="k">then</span> <span class="nb">echo</span> <span class="s2">&quot;Error: certificate with the CN $CN alread exists!&quot;</span>
</span><span class='line'>      <span class="nb">echo</span> <span class="s2">&quot;    $OPENVPN_KEYS/$CN.crt&quot;</span>
</span><span class='line'>  <span class="nb">exit</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Enter the easy-rsa directory and establish the default variables</span>
</span><span class='line'><span class="nb">cd</span> <span class="nv">$OPENVPN_RSA_DIR</span>
</span><span class='line'><span class="nb">source</span> ./vars &gt; /dev/null
</span><span class='line'><span class="nb">export </span><span class="nv">KEY_CN</span><span class="o">=</span><span class="s2">&quot;$CN&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Copied from build-key script (to ensure it works!)</span>
</span><span class='line'><span class="nb">export </span><span class="nv">EASY_RSA</span><span class="o">=</span><span class="s2">&quot;${EASY_RSA:-.}&quot;</span>
</span><span class='line'><span class="s2">&quot;$EASY_RSA/pkitool&quot;</span> --batch <span class="nv">$CN</span>
</span><span class='line'>
</span><span class='line'><span class="c"># cat keys and certs inline the .opvn file for easier exchange</span>
</span><span class='line'><span class="nv">DEFAULT</span><span class="o">=</span><span class="s2">&quot;default.ovpn&quot;</span>
</span><span class='line'><span class="nv">FILEEXT</span><span class="o">=</span><span class="s2">&quot;.ovpn&quot;</span>
</span><span class='line'><span class="nv">CRT</span><span class="o">=</span><span class="s2">&quot;.crt&quot;</span>
</span><span class='line'><span class="nv">CSR</span><span class="o">=</span><span class="s2">&quot;.csr&quot;</span>
</span><span class='line'><span class="nv">KEY</span><span class="o">=</span><span class="s2">&quot;.key&quot;</span>
</span><span class='line'><span class="nv">CA</span><span class="o">=</span><span class="s2">&quot;ca.crt&quot;</span>
</span><span class='line'><span class="nv">TA</span><span class="o">=</span><span class="s2">&quot;ta.key&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c">#1st Verify that client&#39;s Public Key Exists</span>
</span><span class='line'><span class="nb">cd</span> <span class="nv">$OPENVPN_KEYS</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$CN$CRT</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'> <span class="nb">echo</span> <span class="s2">&quot;[ERROR]: Client Public Key Certificate not found: $CN$CRT&quot;</span>
</span><span class='line'> <span class="nb">exit</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Client&#39;s cert found: $CN$CR&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Then, verify that there is a private key for that client</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$CN$KEY</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'> <span class="nb">echo</span> <span class="s2">&quot;[ERROR]: Client Private Key not found: $CN$KEY&quot;</span>
</span><span class='line'> <span class="nb">exit</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Client&#39;s Private Key found: $CN$KEY&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Confirm the CA public key exists</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$CA</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'> <span class="nb">echo</span> <span class="s2">&quot;[ERROR]: CA Public Key not found: $CA&quot;</span>
</span><span class='line'> <span class="nb">exit</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;CA public Key found: $CA&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Confirm the tls-auth ta key file exists</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$TA</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'> <span class="nb">echo</span> <span class="s2">&quot;[ERROR]: tls-auth Key not found: $TA&quot;</span>
</span><span class='line'> <span class="nb">exit</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;tls-auth Private Key found: $TA&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Ready to make a new .opvn file - Start by populating with the default file</span>
</span><span class='line'><span class="nb">cd</span> <span class="nv">$KEY_DOWNLOAD_PATH</span>
</span><span class='line'>cat <span class="nv">$OPENVPN_RSA_DIR</span>/<span class="nv">$DEFAULT</span> &gt; <span class="nv">$CN$FILEEXT</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Now, append the CA Public Cert</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;&lt;ca&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
</span><span class='line'>cat <span class="nv">$OPENVPN_DIR</span>/<span class="nv">$CA</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;&lt;/ca&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Next append the client Public Cert</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;&lt;cert&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
</span><span class='line'>cat <span class="nv">$OPENVPN_KEYS</span>/<span class="nv">$CN$CRT</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;&lt;/cert&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Then, append the client Private Key</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;&lt;key&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
</span><span class='line'>cat <span class="nv">$OPENVPN_KEYS</span>/<span class="nv">$CN$KEY</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;&lt;/key&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Finally, append the TA Private Key</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;key direction 1&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;&lt;tls-auth&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
</span><span class='line'>cat <span class="nv">$OPENVPN_DIR</span>/<span class="nv">$TA</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;&lt;/tls-auth&gt;&quot;</span> &gt;&gt; <span class="nv">$CN$FILEEXT</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Take the new cert and place it somewhere it can be downloaded securely</span>
</span><span class='line'>chmod <span class="m">666</span> <span class="nv">$CN$FILEEXT</span>
</span><span class='line'>rm <span class="nv">$OPENVPN_KEYS</span>/<span class="nv">$CN$CRT</span>
</span><span class='line'>rm <span class="nv">$OPENVPN_KEYS</span>/<span class="nv">$CN$KEY</span>
</span><span class='line'>rm <span class="nv">$OPENVPN_KEYS</span>/<span class="nv">$CN$CSR</span>
</span></code></pre></td></tr></table></div></figure>


<p>Dieses Skript benötigt eine <code>default.ovpn</code> Datei in der die Standard Konfiguration enthalten ist bis auf die Client Schlüssel.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo su
</span><span class='line'><span class="nb">cd</span> /etc/openvpn/easy-rsa/
</span><span class='line'>nano default.ovpn
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mode client
</span><span class='line'>
</span><span class='line'><span class="c"># interface to use for vpn</span>
</span><span class='line'>dev tun
</span><span class='line'>
</span><span class='line'><span class="c"># protocol to use for vpn</span>
</span><span class='line'>proto udp
</span><span class='line'>
</span><span class='line'><span class="c"># hostname/ip of vpn server</span>
</span><span class='line'>remote nilslutz.de <span class="m">1194</span>
</span><span class='line'>
</span><span class='line'><span class="c"># hostname lookup of vpn server</span>
</span><span class='line'>resolv-retry infinite
</span><span class='line'>
</span><span class='line'><span class="c"># no local port bind is necessary</span>
</span><span class='line'>nobind
</span><span class='line'>
</span><span class='line'><span class="c"># persistance</span>
</span><span class='line'>persist-key
</span><span class='line'>persist-tun
</span><span class='line'>
</span><span class='line'><span class="c"># compression</span>
</span><span class='line'>comp-lzo
</span><span class='line'>
</span><span class='line'><span class="c"># logging</span>
</span><span class='line'>verb 3
</span><span class='line'>
</span><span class='line'><span class="c"># cipher suites</span>
</span><span class='line'>cipher AES-256-CBC
</span><span class='line'>auth SHA512
</span><span class='line'>tls-cipher DHE-RSA-AES256-SHA
</span><span class='line'>
</span><span class='line'><span class="c"># server cert verification</span>
</span><span class='line'>remote-cert-tls server
</span><span class='line'>
</span><span class='line'><span class="c"># public/private keys and CA</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nachdem auch dieses Skript angelegt ist lassen sich damit Client Konfigurationen anlegen.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./build-client-config &lt;CLIENT NAME&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Die damit erstelle <code>.ovpn</code> Datei kann dann an den Client weitergegeben werden. Ob nun über eine Website, Mail oder sonstiges ist jedem selbst überlassen.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Nils Lutz</span></span>

      








  


<time datetime="2014-10-21T17:00:00+02:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/raspberrypi/'>raspberrypi</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://nlsltz.github.io/2014/10/21/openvpn-auf-dem-raspberry-pi-einrichten/" data-via="" data-counturl="http://nlsltz.github.io/2014/10/21/openvpn-auf-dem-raspberry-pi-einrichten/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2014/09/04/umstieg-von-wordpress-auf-octopress/" title="Previous Post: Umstieg von Wordpress auf Octopress">&laquo; Umstieg von Wordpress auf Octopress</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014/10/21/openvpn-auf-dem-raspberry-pi-einrichten/">OpenVPN auf dem RaspberryPi einrichten</a>
      </li>
    
      <li class="post">
        <a href="/2014/09/04/umstieg-von-wordpress-auf-octopress/">Umstieg von Wordpress auf Octopress</a>
      </li>
    
      <li class="post">
        <a href="/2014/02/16/plex-media-server-einrichten/">Plex Media Server einrichten</a>
      </li>
    
      <li class="post">
        <a href="/2014/02/09/default-user-und-swap-grosse-des-raspberry-pi-andern/">Default User und Swap Grösse des Raspberry Pi ändern</a>
      </li>
    
      <li class="post">
        <a href="/2014/02/07/hello-world/">Hello World!</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/nlsltz">@nlsltz</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'nlsltz',
            count: 0,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


      </div>
    </div>
    <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Nils Lutz -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a></span>
</p>

</footer>
    



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  </div>
</body>
</html>
